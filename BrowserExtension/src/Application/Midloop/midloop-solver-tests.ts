import assert from 'assert';
import { MidLoopSolver } from './midloop-solver.js';
import { drawGridSolution, normalizeGridString } from '../Base/test-utils.js';


declare const global: any;
// @ts-ignore
const initZ3 = await import('../../../libs/z3-built.js');
global.initZ3 = initZ3.default || initZ3;
// @ts-ignore
await import('../../../libs/z3-bundle.js');

function solutionToString(solution: any, rows: number, cols: number): string {
    return drawGridSolution(solution, rows, cols, (r, c) => null, "\u00b7");
}

const _ = 0;

describe('MidLoopSolver Tests', () => {
    let z3: any;

    beforeAll(async () => {
        z3 = await (global as any).Z3();
        try {
            z3.setParam('parallel.enable', 'false');
        } catch (e) {
            console.warn("Could not set global parallel.enable in tests", e);
        }
    });

    const testCases = [
        {
            name: 'test_minimal_solution_3x3',
            grid: [
                [_, _, _, _, _],
                [_, _, _, _, _],
                [1, _, _, _, 1],
                [_, _, _, _, _],
                [_, _, _, _, _],
            ],
            expected:
                " ┌─────┐ \n" +
                " │  ·  │ \n" +
                " └─────┘ "
        },
        {
            name: 'test_solution_with_edge_vertical_symetry_3x3',
            grid: [
                [_, _, _, _, _],
                [1, _, _, _, _],
                [_, _, _, _, 1],
                [_, _, _, _, _],
                [_, _, _, _, _],
            ],
            expected:
                " ┌─────┐ \n" +
                " └──┐  │ \n" +
                " ·  └──┘ "
        },
        {
            name: 'test_solution_6x6_0xm72',
            grid: [
                [_, _, _, _, _, _, _, _, _, _, _],
                [_, _, _, _, _, _, _, _, 1, _, _],
                [_, _, _, _, _, _, 1, _, _, _, _],
                [_, _, _, _, _, _, _, _, _, _, _],
                [_, _, _, _, _, _, _, 1, _, _, _],
                [1, _, _, _, _, _, _, _, _, _, _],
                [_, _, _, _, _, _, _, _, _, _, _],
                [_, _, _, _, _, _, _, _, 1, _, _],
                [_, _, _, _, _, _, _, _, _, _, 1],
                [_, _, 1, _, 1, _, _, _, _, _, _],
                [_, _, _, _, _, _, _, _, _, _, _],
            ],
            expected:
                " ┌─────┐  ·  ┌──┐ \n" +
                " │  ·  └─────┘  │ \n" +
                " │  ·  ┌────────┘ \n" +
                " │  ·  └──┐  ┌──┐ \n" +
                " │  ┌──┐  └──┘  │ \n" +
                " └──┘  └────────┘ "
        },
        {
            name: 'test_solution_7x7_168q6',
            grid: [
                [_, _, 1, _, _, _, _, _, 1, _, _, _, _],
                [_, _, _, _, _, _, _, _, _, _, _, _, _],
                [_, 1, _, _, _, _, 1, _, _, _, _, _, _],
                [_, _, _, _, _, _, _, _, _, _, _, _, _],
                [_, _, _, _, _, _, _, _, _, _, _, _, _],
                [_, _, 1, _, _, _, _, _, _, _, _, _, 1],
                [_, _, _, _, _, _, _, 1, _, _, 1, _, _],
                [_, _, _, _, _, _, _, _, _, _, _, _, _],
                [_, _, _, _, _, _, 1, _, _, _, _, _, _],
                [_, _, _, _, _, _, _, _, _, _, _, _, _],
                [_, _, _, _, _, _, _, _, _, _, _, _, _],
                [_, _, _, _, _, _, _, _, _, _, _, _, _],
                [_, 1, _, _, _, _, _, _, 1, _, _, _, _],
            ],
            expected:
                " ┌─────┐  ┌─────┐  · \n" +
                " └──┐  │  │  ·  └──┐ \n" +
                " ·  │  └──┘  ┌──┐  │ \n" +
                " ·  │  ·  ┌──┘  │  │ \n" +
                " ┌──┘  ·  │  ·  └──┘ \n" +
                " │  ┌──┐  └────────┐ \n" +
                " └──┘  └───────────┘ "
        },
        {
            name: 'test_solution_8x8_0z44g',
            skip: true, // Skipped in Python
            grid: [
                [_, _, _, 1, _, _, _, _, _, _, _, 1, _, _, _],
                [_, _, _, _, _, _, _, _, _, _, _, _, _, _, _],
                [_, _, _, _, _, _, _, _, _, _, _, _, _, _, _],
                [_, _, _, _, _, _, _, _, _, _, _, _, _, _, 1],
                [1, _, _, _, _, _, 1, _, _, _, _, _, _, _, _],
                [_, _, _, _, _, _, _, _, _, _, _, _, _, _, _],
                [_, _, _, _, _, _, _, _, 1, _, _, _, 1, _, _],
                [_, _, _, _, _, _, _, _, _, _, _, _, _, _, _],
                [_, _, _, _, _, 1, _, _, _, _, 1, _, _, _, _],
                [_, _, _, _, _, _, _, _, _, _, _, _, _, _, _],
                [_, _, 1, _, 1, _, _, _, _, _, _, _, _, _, _],
                [_, _, _, _, _, _, _, _, _, _, _, _, _, _, 1],
                [_, 1, _, _, _, _, _, _, _, _, _, _, _, _, _],
                [_, _, _, _, _, _, _, _, _, _, _, _, _, _, _],
                [_, _, _, _, _, _, _, 1, _, _, _, _, _, _, _],
            ],
            expected:
                " ┌────────┐  ┌────────┐ \n" +
                " │  ·  ·  │  │  ·  ·  │ \n" +
                " │  ·  ·  │  │  ·  ·  │ \n" +
                " │  ·  ·  │  │  ┌─────┘ \n" +
                " └──┐  ┌──┘  │  │  ┌──┐ \n" +
                " ·  │  │  ·  │  └──┘  │ \n" +
                " ┌──┘  └─────┘  ·  ·  │ \n" +
                " └────────────────────┘ "
        },
        {
            name: 'test_solution_9x9',
            skip: true,
            grid: [
                [_, _, _, _, 1, _, _, _, _, _, _, _, _, _, _, _, _],
                [_, _, _, _, _, _, _, _, _, _, _, _, 1, _, 1, _, _],
                [1, _, _, _, _, _, _, _, _, _, 1, _, _, _, _, _, _],
                [_, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _],
                [_, _, 1, _, _, _, _, _, _, _, _, 1, _, _, _, _, _],
                [_, _, _, _, _, _, 1, _, _, _, _, _, _, _, _, _, 1],
                [_, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _],
                [1, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _],
                [_, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _],
                [_, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _],
                [_, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _],
                [_, _, 1, _, _, _, _, _, _, _, _, _, _, _, _, _, _],
                [_, _, _, _, _, 1, _, _, _, _, _, _, _, _, _, _, _],
                [_, _, _, _, _, _, _, _, 1, _, 1, _, _, _, _, _, _],
                [_, _, _, _, _, _, _, _, _, _, _, _, _, _, _, 1, _],
                [1, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, 1],
                [_, _, _, _, 1, _, _, _, _, _, _, _, _, 1, _, _, _],
            ],
            expected:
                " ┌───────────┐  ┌──┐  ┌──┐ \n" +
                " │  ·  ·  ·  │  │  └──┘  │ \n" +
                " └─────┐  ┌──┘  └──┐  ·  │ \n" +
                " ┌─────┘  └────────┘  ·  │ \n" +
                " └──┐  ┌───────────┐  ·  │ \n" +
                " ·  │  │  ┌──┐  ┌──┘  ┌──┘ \n" +
                " ·  │  └──┘  │  │  ·  │  · \n" +
                " ┌──┘  ·  ·  │  │  ·  └──┐ \n" +
                " └───────────┘  └────────┘ "
        },
        {
            name: 'test_solution_10x10_0mdr8',
            grid: [
                [_, _, _, _, _, _, 1, _, _, _, _, _, _, _, _, _, _, 1, _],
                [_, _, _, _, _, _, _, _, _, _, _, _, 1, _, _, _, _, _, _],
                [_, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, 1, _, _],
                [_, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _],
                [_, _, _, _, _, _, 1, _, _, _, _, _, _, _, 1, _, _, _, _],
                [_, _, _, _, 1, _, _, _, _, _, _, _, _, _, _, _, _, _, _],
                [_, _, 1, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _],
                [_, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _],
                [_, _, _, _, _, _, _, _, _, _, _, _, _, _, _, 1, _, _, _],
                [1, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _],
                [_, _, 1, _, _, _, 1, _, _, _, 1, _, _, _, _, 1, _, _, _],
                [_, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _],
                [_, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _],
                [1, _, _, _, _, _, _, _, _, _, _, _, _, _, 1, _, _, _, _],
                [_, _, _, _, _, _, _, _, 1, _, _, _, _, _, _, _, _, _, 1],
                [_, _, _, _, 1, _, _, _, _, _, _, _, _, _, _, _, _, _, _],
                [_, _, _, _, _, _, _, _, _, _, _, _, 1, _, _, _, _, _, _],
                [_, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _],
                [_, _, _, 1, _, _, _, _, _, 1, _, _, _, _, _, 1, _, _, _],
            ],
            expected:
                " ┌─────────────────┐  ·  ┌──┐ \n" +
                " │  ·  ·  ·  ·  ┌──┘  ·  │  │ \n" +
                " └──┐  ┌─────┐  │  ┌─────┘  │ \n" +
                " ·  │  └──┐  │  └──┘  ·  ·  │ \n" +
                " ┌──┘  ·  │  └──┐  ┌────────┘ \n" +
                " └─────┐  │  ·  │  └────────┐ \n" +
                " ┌─────┘  │  ·  └─────┐  ·  │ \n" +
                " └─────┐  └─────┐  ┌──┘  ·  │ \n" +
                " ┌─────┘  ┌──┐  │  │  ·  ·  │ \n" +
                " └────────┘  └──┘  └────────┘ "
        },
        {
            name: 'test_solution_12x12_0deww',
            skip: true,
            grid: [
                [_, _, 1, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, 1, _, _, _],
                [_, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _],
                [_, _, _, _, _, _, _, 1, _, _, _, _, 1, _, _, 1, _, _, _, _, _, _, _],
                [1, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, 1],
                [_, _, _, _, _, _, _, _, _, _, _, _, _, _, _, 1, _, _, _, _, _, _, _],
                [_, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _],
                [_, _, _, _, 1, _, _, _, _, _, 1, _, _, _, _, _, _, _, 1, _, _, _, _],
                [_, _, _, _, _, _, _, _, 1, _, _, _, _, _, _, _, _, _, _, _, _, _, _],
                [_, _, _, _, _, _, _, 1, _, _, _, _, _, _, _, _, 1, _, _, _, _, _, _],
                [_, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _],
                [_, 1, _, _, _, _, _, _, _, _, _, _, 1, _, _, _, _, _, _, _, _, 1, _],
                [_, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _],
                [_, _, _, _, _, _, _, _, _, 1, _, _, _, _, _, _, _, 1, _, _, _, _, 1],
                [_, _, 1, _, _, _, _, _, _, _, _, _, 1, _, _, _, _, _, _, _, 1, _, _],
                [_, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _],
                [_, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _],
                [_, _, _, _, _, _, 1, _, _, _, _, _, _, _, _, _, _, _, 1, _, _, _, _],
                [_, _, _, _, _, _, _, _, _, _, 1, _, _, _, _, _, _, _, _, _, _, _, _],
                [1, _, _, _, _, 1, _, _, _, 1, _, _, _, _, _, _, _, _, _, _, _, _, _],
                [_, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, 1],
                [_, 1, _, _, _, _, 1, _, 1, _, _, 1, _, _, _, _, _, _, 1, _, 1, _, _],
                [_, _, _, _, _, _, _, _, _, _, 1, _, _, _, _, _, _, _, _, _, _, _, _],
                [_, _, _, 1, _, _, _, _, _, _, _, _, _, _, 1, _, _, _, _, _, _, 1, _],
            ],
            expected:
                " ┌─────┐  ·  ·  ·  ┌──┐  ┌────────┐ \n" +
                " │  ·  └────────┐  │  └──┘  ·  ·  │ \n" +
                " │  ·  ·  ·  ·  │  └────────┐  ·  │ \n" +
                " └───────────┐  │  ·  ·  ·  │  ┌──┘ \n" +
                " ┌─────┐  ┌──┘  │  ·  ┌─────┘  │  · \n" +
                " └──┐  │  │  ·  └─────┘  ·  ·  └──┐ \n" +
                " ·  │  │  └────────┐  ┌────────┐  │ \n" +
                " ·  │  │  ·  ┌─────┘  │  ·  ·  └──┘ \n" +
                " ┌──┘  └─────┘  ┌──┐  └───────────┐ \n" +
                " │  ·  ┌──┐  ┌──┘  │  ·  ·  ┌──┐  │ \n" +
                " └──┐  │  │  │  ┌──┘  ·  ·  │  │  │ \n" +
                " ·  └──┘  └──┘  └───────────┘  └──┘ "
        },
        {
            name: 'test_solution_12x12_a',
            skip: true,
            grid: [
                [_, _, _, _, _, 1, _, _, _, _, _, _, _, _, _, _, 1, _, _, _, _, _, _],
                [_, _, _, _, _, _, _, _, _, _, 1, _, _, _, _, _, _, _, _, _, _, _, _],
                [_, _, _, _, _, _, _, _, _, _, _, _, 1, _, _, _, _, _, _, _, 1, _, _],
                [_, _, _, _, _, _, _, _, 1, _, _, _, _, _, _, _, _, _, _, _, _, _, _],
                [1, _, _, _, 1, _, _, _, _, _, _, _, _, _, _, 1, _, _, _, _, _, _, 1],
                [_, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _],
                [_, _, _, _, _, _, 1, _, _, _, _, _, 1, _, _, _, _, _, _, _, _, _, _],
                [_, _, _, _, _, _, _, _, 1, _, _, _, _, _, _, _, _, _, 1, _, _, _, _],
                [_, _, _, _, _, _, _, 1, _, _, _, _, _, _, _, _, _, _, _, _, 1, _, _],
                [_, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _],
                [_, 1, _, _, 1, _, _, _, 1, _, _, _, _, _, _, 1, _, _, _, _, _, _, _],
                [_, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _],
                [_, _, _, _, _, _, _, _, _, _, _, _, 1, _, _, _, 1, _, _, _, _, _, _],
                [_, _, _, _, _, _, _, _, _, _, _, _, _, _, 1, _, _, _, _, _, _, _, _],
                [_, _, _, _, _, _, _, 1, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _],
                [_, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, 1, _, _, _, _],
                [_, _, _, _, _, _, _, _, _, 1, _, _, _, _, _, _, _, _, _, _, 1, _, _],
                [_, _, 1, _, _, _, _, _, _, _, _, _, _, _, 1, _, _, _, _, _, _, _, _],
                [_, _, _, _, _, _, _, _, _, _, _, _, _, 1, _, _, _, _, _, _, _, 1, _],
                [_, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _],
                [_, _, _, _, 1, _, 1, _, _, _, _, _, _, _, _, _, 1, _, _, _, _, _, _],
                [1, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _],
                [_, _, _, _, _, _, _, _, _, _, 1, _, _, _, _, _, _, _, 1, _, _, _, _],
            ],
            expected:
                " ┌──────────────┐  ·  ┌─────┐  ·  · \n" +
                " │  ·  ┌─────┐  └─────┘  ·  └─────┐ \n" +
                " │  ·  │  ·  └──┐  ┌────────┐  ·  │ \n" +
                " │  ·  └─────┐  │  │  ·  ·  │  ┌──┘ \n" +
                " └─────┐  ┌──┘  └──┘  ·  ·  │  │  · \n" +
                " ┌──┐  │  └─────┐  ┌────────┘  └──┐ \n" +
                " │  └──┘  ·  ·  │  │  ┌─────┐  ·  │ \n" +
                " └──┐  ┌────────┘  └──┘  ·  │  ┌──┘ \n" +
                " ·  │  └──────────────┐  ·  │  │  · \n" +
                " ·  │  ┌──┐  ·  ·  ┌──┘  ┌──┘  └──┐ \n" +
                " ┌──┘  │  │  ·  ·  └──┐  │  ·  ┌──┘ \n" +
                " └─────┘  └───────────┘  └─────┘  · "
        },
        {
            name: 'test_solution_12x12_5j2e0',
            grid: [
                [_, _, _, _, 1, _, _, _, _, _, _, _, 1, _, _, _, _, _, _, 1, _, _, _],
                [_, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _],
                [_, _, _, _, _, _, _, _, 1, _, _, _, _, _, _, 1, _, _, _, _, _, _, _],
                [_, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _],
                [_, _, _, _, _, 1, _, _, _, _, _, _, 1, _, _, _, _, _, _, _, _, _, 1],
                [_, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, 1, _, _, _, _],
                [_, _, _, _, _, _, _, _, _, 1, _, _, _, _, _, _, _, _, _, _, _, _, _],
                [_, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _],
                [_, _, _, _, 1, _, _, _, _, 1, _, _, _, _, _, _, _, _, _, _, 1, _, _],
                [_, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _],
                [_, _, _, 1, _, _, _, _, _, _, _, _, 1, _, _, _, _, _, _, _, 1, _, _],
                [_, _, 1, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _],
                [_, _, _, _, _, _, _, 1, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _],
                [_, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, 1],
                [_, _, _, _, 1, _, _, _, 1, _, _, _, _, _, _, _, _, 1, _, _, _, _, _],
                [_, _, _, _, _, _, _, _, _, _, 1, _, 1, _, _, _, _, _, _, _, _, _, _],
                [_, _, _, _, _, _, _, _, 1, _, _, _, _, _, _, _, _, _, 1, _, _, _, _],
                [_, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _],
                [_, _, _, _, _, _, _, _, _, 1, _, _, _, _, _, _, _, _, _, _, _, 1, _],
                [_, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _],
                [1, _, _, _, _, _, _, _, _, _, 1, _, _, _, _, _, _, _, _, _, _, _, 1],
                [_, _, _, _, _, _, _, _, 1, _, _, _, 1, _, _, _, _, _, _, _, _, _, _],
                [_, _, _, _, 1, _, _, _, _, _, _, _, _, _, _, _, _, _, _, 1, _, _, _],
            ],
            expected:
                " ┌───────────┐  ┌─────┐  ┌────────┐ \n" +
                " │  ·  ·  ·  │  └──┐  └──┘  ·  ·  │ \n" +
                " │  ┌────────┘  ·  │  ┌─────┐  ·  │ \n" +
                " │  │  ·  ┌────────┘  │  ┌──┘  ·  │ \n" +
                " │  └─────┘  ┌──┐  ·  │  │  ┌─────┘ \n" +
                " │  ┌──┐  ·  │  └─────┘  │  └─────┐ \n" +
                " └──┘  │  ┌──┘  ·  ┌──┐  │  ·  ·  │ \n" +
                " ·  ·  │  └─────┐  │  │  └──┐  ·  │ \n" +
                " ·  ·  │  ┌─────┘  │  │  ·  │  ┌──┘ \n" +
                " ┌─────┘  └────────┘  │  ┌──┘  └──┐ \n" +
                " │  ·  ·  ·  ┌─────┐  │  │  ·  ·  │ \n" +
                " └───────────┘  ·  └──┘  └────────┘ "
        }
    ];

    for (const t of testCases) {
        const testFn = (t as any).skip ? it.skip : it;
        testFn(t.name, async () => {
            const ctx = new z3.Context('main');
            const solver = new MidLoopSolver(ctx, t.grid);
            const solution = await solver.solve();

            assert.ok(solution, "Expected solution but got null");

            const rows = Math.floor((t.grid.length + 1) / 2);
            const cols = Math.floor((t.grid[0].length + 1) / 2);
            const actual = solutionToString(solution, rows, cols);

            const expectedNorm = normalizeGridString(t.expected);
            const actualNorm = normalizeGridString(actual);

            assert.strictEqual(actualNorm, expectedNorm);

            // Test uniqueness (equivalent to get_other_solution == empty)
            const otherSolution = await solver.solve(solution);
            assert.strictEqual(otherSolution, null, "Expected unique solution but found another one");
        });
    }
});
